From add691189775b8a15058e2bc102b79575afbf08d Mon Sep 17 00:00:00 2001
From: Mahyar Koshkouei <mahyar.koshkouei@gmail.com>
Date: Tue, 26 Dec 2017 14:06:32 +0000
Subject: [PATCH 1/1] Add support for toolchain w/o locale

Signed-off-by: Mahyar Koshkouei <mahyar.koshkouei@gmail.com>
---
 Makefile.common                          | 3 +++
 libretro-common/compat/fopen_utf8.c      | 2 +-
 libretro-common/encodings/encoding_utf.c | 2 ++
 qb/config.libs.sh                        | 4 ++++
 qb/config.params.sh                      | 1 +
 5 files changed, 11 insertions(+), 1 deletion(-)

diff --git a/Makefile.common b/Makefile.common
index e342c9ef7..10f0a8098 100644
--- a/Makefile.common
+++ b/Makefile.common
@@ -60,6 +60,9 @@ ifeq ($(SCALER_NO_SIMD), 1)
    DEFINES += -DSCALER_NO_SIMD
 endif
 
+ifeq ($(HAVE_LOCALE), 1)
+	DEFINES += -DHAVE_LOCALE
+endif
 
 ifeq ($(HAVE_PRESERVE_DYLIB),1)
    DEFINES += -DNO_DLCLOSE
diff --git a/libretro-common/compat/fopen_utf8.c b/libretro-common/compat/fopen_utf8.c
index b61c53ebd..a3ca6c881 100644
--- a/libretro-common/compat/fopen_utf8.c
+++ b/libretro-common/compat/fopen_utf8.c
@@ -13,7 +13,7 @@
 
 FILE* fopen_utf8(const char * filename, const char * mode)
 {
-#if defined(_XBOX)
+#if defined(_XBOX) || !defined(HAVE_LOCALE)
    return fopen(filename, mode);
 #elif defined(LEGACY_WIN32)
    char * filename_local = utf8_to_local_string_alloc(filename);
diff --git a/libretro-common/encodings/encoding_utf.c b/libretro-common/encodings/encoding_utf.c
index d1ec88298..cc62497d8 100644
--- a/libretro-common/encodings/encoding_utf.c
+++ b/libretro-common/encodings/encoding_utf.c
@@ -369,6 +369,7 @@ char* local_to_utf8_string_alloc(const char *str)
    return mb_to_mb_string_alloc(str, CODEPAGE_LOCAL, CODEPAGE_UTF8);
 }
 
+#ifndef HAVE_LOCALE
 /* Returned pointer MUST be freed by the caller if non-NULL. */
 wchar_t* utf8_to_utf16_string_alloc(const char *str)
 {
@@ -512,3 +513,4 @@ char* utf16_to_utf8_string_alloc(const wchar_t *str)
 
    return buf;
 }
+#endif
diff --git a/qb/config.libs.sh b/qb/config.libs.sh
index 615c36853..b23d19541 100644
--- a/qb/config.libs.sh
+++ b/qb/config.libs.sh
@@ -471,6 +471,10 @@ if [ "$HAVE_V4L2" != 'no' ] && [ "$HAVE_VIDEOPROCESSOR" != 'no' ]; then
    HAVE_VIDEO_PROCESSOR=yes
 fi
 
+if [ "$HAVE_LOCALE" = "yes" ]; then
+   add_define MAKEFILE HAVE_LOCALE "1"
+fi
+
 # Creates config.mk and config.h.
 add_define MAKEFILE GLOBAL_CONFIG_DIR "$GLOBAL_CONFIG_DIR"
 set -- $(set | grep ^HAVE_)
diff --git a/qb/config.params.sh b/qb/config.params.sh
index 9d20ca8c7..e43a661d4 100644
--- a/qb/config.params.sh
+++ b/qb/config.params.sh
@@ -107,3 +107,4 @@ HAVE_LANGEXTRA=yes         # Multi-language support
 HAVE_OSMESA=no             # Off-screen Mesa rendering
 HAVE_VIDEOPROCESSOR=auto   # Enable video processor core
 HAVE_VIDEOCORE=auto        # Broadcom Videocore 4 support
+HAVE_LOCALE=yes             # Wide character & locale support
-- 
2.15.1

